<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio - IFL Watches Custom Designs</title>
    
    <!-- Shared styles (DRY!) -->
    <link rel="stylesheet" href="shared/styles.css">
    <link rel="stylesheet" href="shared/navigation.css">
    <link rel="stylesheet" href="shared/portfolio-styles-v2.css">
    <link rel="stylesheet" href="shared/portfolio-filters-v2.css">
    <link rel="stylesheet" href="shared/modal-styles.css">
    
    <!-- Navigation script -->
    <script src="shared/navigation.js"></script>
    
    <!-- Portfolio data -->
    <script src="shared/portfolio-data-v2.js"></script>
</head>
<body>
    <!-- Navigation будет вставлена автоматически через navigation.js -->

    <!-- Portfolio Content -->
    <main class="portfolio-container">
        <!-- Header -->
        <div class="portfolio-header">
            <h1>PORTFOLIO</h1>
            <p>Explore our collection of hand-painted masterpieces</p>
        </div>
        
        <!-- Controls Bar - НЕ ДВИГАЕТСЯ -->
        <div class="portfolio-controls">
            <button class="filter-trigger" id="filterTrigger">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="4" y1="6" x2="20" y2="6"/>
                    <line x1="7" y1="12" x2="20" y2="12"/>
                    <line x1="10" y1="18" x2="20" y2="18"/>
                </svg>
                <span>Filter</span>
            </button>
            
            <div class="results-counter" id="resultsCounter">
                Showing <strong>0</strong> projects
            </div>
        </div>
        
        <!-- Content Wrapper - фильтры и сетка вместе -->
        <div class="portfolio-content-wrapper">
            <!-- Filter Sidebar - как колонка -->
            <aside class="filter-sidebar" id="filterSidebar">
                <div class="filter-header">
                    <h3>Filters</h3>
                    <button class="close-filters-mobile" id="closeFiltersMobile">×</button>
                </div>
                
                <button class="clear-filters" id="clearFilters">Clear All</button>
                
                <!-- Style Filter -->
                <div class="filter-section">
                    <h4 class="filter-section-title">Style</h4>
                    <div class="filter-pills" id="styleFilters">
                        <!-- Will be populated dynamically -->
                    </div>
                </div>
                
                <!-- Theme Filter -->
                <div class="filter-section">
                    <h4 class="filter-section-title">Theme</h4>
                    <div class="filter-pills" id="themeFilters">
                        <!-- Will be populated dynamically -->
                    </div>
                </div>
                
                <!-- Watch Model Filter -->
                <div class="filter-section">
                    <h4 class="filter-section-title">Watch Model</h4>
                    <div class="filter-pills" id="modelFilters">
                        <!-- Will be populated dynamically -->
                    </div>
                </div>
                
                <div class="filter-results" id="filterResults">
                    <strong>0</strong> projects found
                </div>
            </aside>
            
            <!-- Grid Container -->
            <div class="portfolio-grid-container">
                <!-- Portfolio Grid -->
                <div class="portfolio-grid" id="portfolioGrid">
                    <div class="portfolio-loading">Loading portfolio...</div>
                </div>
            </div>
        </div>
        
        <!-- Pagination -->
        <div class="pagination" id="pagination">
            <!-- Will be populated dynamically -->
        </div>
    </main>

    <script>
        // Portfolio Grid Class with Behance-style filters
        class PortfolioGrid {
            constructor() {
                this.grid = document.getElementById('portfolioGrid');
                this.filters = {
                    style: '',
                    theme: '',
                    model: ''
                };
                this.currentPage = 1;
                this.itemsPerPage = 12;
                this.allItems = [];
                this.filteredItems = [];
                this.watchModels = new Set(); // Collect unique watch models
                
                this.init();
            }
            
            init() {
                this.loadData();
                this.populateFilters();
                this.attachEventListeners();
                this.render();
            }
            
            loadData() {
                // Get all active items
                this.allItems = portfolioHelpers.getActiveItems();
                
                // Extract unique watch models
                this.allItems.forEach(item => {
                    if (item.watch_product && item.watch_product.vendor) {
                        this.watchModels.add(item.watch_product.vendor);
                    }
                });
            }
            
            populateFilters() {
                // Populate style filters as pills
                const styleContainer = document.getElementById('styleFilters');
                portfolioMetaobjects.styles.forEach(style => {
                    const pill = document.createElement('button');
                    pill.className = 'filter-pill';
                    pill.dataset.type = 'style';
                    pill.dataset.value = style.id;
                    pill.textContent = style.name;
                    pill.onclick = () => this.toggleFilter('style', style.id, pill);
                    styleContainer.appendChild(pill);
                });
                
                // Populate theme filters as pills
                const themeContainer = document.getElementById('themeFilters');
                portfolioMetaobjects.themes.forEach(theme => {
                    const pill = document.createElement('button');
                    pill.className = 'filter-pill';
                    pill.dataset.type = 'theme';
                    pill.dataset.value = theme.id;
                    pill.textContent = theme.name;
                    pill.onclick = () => this.toggleFilter('theme', theme.id, pill);
                    themeContainer.appendChild(pill);
                });
                
                // Populate watch model filters as pills
                const modelContainer = document.getElementById('modelFilters');
                Array.from(this.watchModels).sort().forEach(model => {
                    const pill = document.createElement('button');
                    pill.className = 'filter-pill';
                    pill.dataset.type = 'model';
                    pill.dataset.value = model;
                    pill.textContent = model;
                    pill.onclick = () => this.toggleFilter('model', model, pill);
                    modelContainer.appendChild(pill);
                });
            }
            
            toggleFilter(type, value, element) {
                if (this.filters[type] === value) {
                    // Deselect
                    this.filters[type] = '';
                    element.classList.remove('active');
                } else {
                    // Select new, deselect others in same category
                    document.querySelectorAll(`.filter-pill[data-type="${type}"]`).forEach(pill => {
                        pill.classList.remove('active');
                    });
                    this.filters[type] = value;
                    element.classList.add('active');
                }
                
                this.currentPage = 1; // Reset to first page
                this.render();
            }
            
            clearAllFilters() {
                this.filters = { style: '', theme: '', model: '' };
                document.querySelectorAll('.filter-pill').forEach(pill => {
                    pill.classList.remove('active');
                });
                this.currentPage = 1;
                this.render();
            }
            
            attachEventListeners() {
                // Filter trigger button
                const filterTrigger = document.getElementById('filterTrigger');
                const filterSidebar = document.getElementById('filterSidebar');
                
                filterTrigger.addEventListener('click', () => {
                    filterTrigger.classList.toggle('active');
                    filterSidebar.classList.toggle('active');
                });
                
                // Close filters on mobile
                const closeFiltersMobile = document.getElementById('closeFiltersMobile');
                if (closeFiltersMobile) {
                    closeFiltersMobile.addEventListener('click', () => {
                        filterTrigger.classList.remove('active');
                        filterSidebar.classList.remove('active');
                    });
                }
                
                // Clear all filters
                document.getElementById('clearFilters').addEventListener('click', () => {
                    this.clearAllFilters();
                });
            }
            
            applyFilters() {
                this.filteredItems = this.allItems.filter(item => {
                    if (this.filters.style && item.style_id !== this.filters.style) return false;
                    if (this.filters.theme && item.theme_id !== this.filters.theme) return false;
                    if (this.filters.model && item.watch_product && 
                        item.watch_product.vendor !== this.filters.model) return false;
                    return true;
                });
            }
            
            render() {
                this.applyFilters();
                
                // Update counters
                const totalItems = this.filteredItems.length;
                const startIndex = (this.currentPage - 1) * this.itemsPerPage;
                const endIndex = Math.min(startIndex + this.itemsPerPage, totalItems);
                const itemsToShow = this.filteredItems.slice(startIndex, endIndex);
                
                // Update results counter
                document.getElementById('resultsCounter').innerHTML = 
                    `Showing <strong>${itemsToShow.length}</strong> of <strong>${totalItems}</strong> projects`;
                
                document.getElementById('filterResults').innerHTML = 
                    `<strong>${totalItems}</strong> project${totalItems !== 1 ? 's' : ''} found`;
                
                // Clear grid
                this.grid.innerHTML = '';
                
                if (itemsToShow.length === 0) {
                    this.grid.innerHTML = '<div class="no-results">No projects found matching your criteria</div>';
                    return;
                }
                
                // Render items
                itemsToShow.forEach(item => {
                    this.grid.innerHTML += this.createCard(item);
                });
                
                // Render pagination
                this.renderPagination(totalItems);
            }
            
            createCard(item) {
                const typeLabels = {
                    'bespoke_concept': 'Bespoke',
                    'custom_order': 'Commission'
                };
                
                const badges = [];
                if (item.video_url) {
                    badges.push(`<span class="badge badge-video">📹 Video</span>`);
                }
                if (item.timelapse_url) {
                    badges.push(`<span class="badge badge-timelapse">⏱️ Timelapse</span>`);
                }
                
                return `
                    <div class="portfolio-card" data-id="${item.id}">
                        <div class="portfolio-image-wrapper" onclick="window.location.href='/portfolio-single.html?id=${item.handle}'">
                            <img src="${item.main_image}" alt="${item.title}" loading="lazy">
                            
                            ${badges.length > 0 ? `
                                <div class="portfolio-badges">
                                    ${badges.join('')}
                                </div>
                            ` : ''}
                            
                            <div class="portfolio-overlay">
                                <button class="btn-quick-view" onclick="event.stopPropagation(); portfolioGrid.openQuickView('${item.id}')">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                        <circle cx="12" cy="12" r="3"/>
                                    </svg>
                                    <span>Quick View</span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="portfolio-info">
                            <h4>${item.title}</h4>
                            <div class="portfolio-meta">
                                <div class="portfolio-tags">
                                    <span class="tag tag-style">${item.style.name}</span>
                                    <span class="tag tag-theme">${item.theme.name}</span>
                                </div>
                                <span class="portfolio-type">${typeLabels[item.portfolio_type]}</span>
                            </div>
                            ${item.watch_product ? 
                                `<p class="portfolio-watch">${item.watch_product.title}</p>` 
                                : ''}
                        </div>
                    </div>
                `;
            }
            
            renderPagination(totalItems) {
                const totalPages = Math.ceil(totalItems / this.itemsPerPage);
                const pagination = document.getElementById('pagination');
                
                if (totalPages <= 1) {
                    pagination.innerHTML = '';
                    return;
                }
                
                let html = '<div class="pagination-controls">';
                
                // Previous button
                html += `<button class="page-btn ${this.currentPage === 1 ? 'disabled' : ''}" 
                         onclick="portfolioGrid.goToPage(${this.currentPage - 1})"
                         ${this.currentPage === 1 ? 'disabled' : ''}>← Previous</button>`;
                
                // Page numbers
                html += '<div class="page-numbers">';
                for (let i = 1; i <= totalPages; i++) {
                    if (i === 1 || i === totalPages || (i >= this.currentPage - 2 && i <= this.currentPage + 2)) {
                        html += `<button class="page-num ${i === this.currentPage ? 'active' : ''}" 
                                onclick="portfolioGrid.goToPage(${i})">${i}</button>`;
                    } else if (i === this.currentPage - 3 || i === this.currentPage + 3) {
                        html += '<span class="page-dots">...</span>';
                    }
                }
                html += '</div>';
                
                // Next button
                html += `<button class="page-btn ${this.currentPage === totalPages ? 'disabled' : ''}" 
                         onclick="portfolioGrid.goToPage(${this.currentPage + 1})"
                         ${this.currentPage === totalPages ? 'disabled' : ''}>Next →</button>`;
                
                html += '</div>';
                pagination.innerHTML = html;
            }
            
            goToPage(page) {
                const totalPages = Math.ceil(this.filteredItems.length / this.itemsPerPage);
                if (page < 1 || page > totalPages) return;
                
                this.currentPage = page;
                this.render();
                
                // Scroll to top of grid
                document.querySelector('.portfolio-header').scrollIntoView({ behavior: 'smooth' });
            }
            
            openQuickView(itemId) {
                const item = portfolioHelpers.getActiveItems().find(p => p.id === itemId);
                if (!item) return;
                
                // Показываем модал
                const modal = document.getElementById('quickViewModal');
                const modalBody = modal.querySelector('.modal-body');
                
                // Генерируем контент для модала
                modalBody.innerHTML = `
                    <div class="quick-view-container">
                        <div class="quick-view-gallery">
                            <div class="main-image">
                                <img src="${item.main_image}" alt="${item.title}">
                            </div>
                            ${item.images && item.images.length > 0 ? `
                                <div class="thumbnail-list">
                                    <div class="thumbnail active">
                                        <img src="${item.main_image}" alt="${item.title}">
                                    </div>
                                    ${item.images.map(img => `
                                        <div class="thumbnail">
                                            <img src="${img}" alt="${item.title}">
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="quick-view-details">
                            <h2>${item.title}</h2>
                            
                            <div class="quick-view-tags">
                                <span class="tag tag-style">${item.style.name}</span>
                                <span class="tag tag-theme">${item.theme.name}</span>
                                <span class="portfolio-type">${this.typeLabels[item.portfolio_type]}</span>
                            </div>
                            
                            <p class="quick-view-description">${item.description || 'A unique custom timepiece design.'}</p>
                            
                            ${item.watch_product ? `
                                <div class="watch-details">
                                    <h3>Watch Details</h3>
                                    <p><strong>Model:</strong> ${item.watch_product.title}</p>
                                    <p><strong>Brand:</strong> ${item.watch_product.vendor}</p>
                                    <p><strong>Size:</strong> ${item.watch_product.size}</p>
                                    <p><strong>Price from:</strong> $${item.watch_product.price}</p>
                                </div>
                            ` : ''}
                            
                            <div class="quick-view-actions">
                                ${item.portfolio_type === 'bespoke_concept' ? 
                                    `<a href="${item.product_reference || '#'}" class="btn btn-primary">Order This Design</a>` :
                                    `<button class="btn btn-primary" onclick="window.location.href='/pages/bespoke'">Order Similar</button>`
                                }
                                <a href="/portfolio-single.html?id=${item.handle}" class="btn btn-secondary">View Full Details</a>
                            </div>
                        </div>
                    </div>
                `;
                
                // Добавляем обработчики для галереи
                const thumbnails = modalBody.querySelectorAll('.thumbnail');
                const mainImage = modalBody.querySelector('.main-image img');
                
                thumbnails.forEach(thumb => {
                    thumb.addEventListener('click', () => {
                        thumbnails.forEach(t => t.classList.remove('active'));
                        thumb.classList.add('active');
                        mainImage.src = thumb.querySelector('img').src;
                    });
                });
                
                // Показываем модал
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
            
            closeQuickView() {
                const modal = document.getElementById('quickViewModal');
                modal.classList.remove('active');
                document.body.style.overflow = '';
            }
        }
        
        // Initialize portfolio grid
        const portfolioGrid = new PortfolioGrid();
    </script>

    <!-- Quick View Modal -->
    <div id="quickViewModal" class="modal">
        <div class="modal-overlay" onclick="portfolioGrid.closeQuickView()"></div>
        <div class="modal-content">
            <button class="modal-close" onclick="portfolioGrid.closeQuickView()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
            <div class="modal-body">
                <!-- Content will be dynamically inserted here -->
            </div>
        </div>
    </div>

</body>
</html>
